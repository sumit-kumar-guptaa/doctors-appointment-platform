generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                   String              @id @default(cuid())
  clerkUserId          String              @unique
  email                String              @unique
  name                 String?
  imageUrl             String?
  role                 UserRole            @default(UNASSIGNED)
  createdAt            DateTime            @default(now())
  updatedAt            DateTime            @updatedAt
  credits              Int                 @default(0)
  specialty            String?
  experience           Int?
  credentialUrl        String?
  description          String?
  verificationStatus   VerificationStatus? @default(PENDING)
  
  // Doctor Verification Fields
  medicalDegree        String?
  licenseNumber        String?
  workingHospital      String?
  consultationFee      Float?
  medicalDegreeUrl     String?
  medicalLicenseUrl    String?
  identityProofUrl     String?
  experienceCertUrl    String?
  verificationNotes    String?
  verifiedAt           DateTime?
  verifiedBy           String?
  
  // Emergency Features
  isEmergencyDoctor    Boolean             @default(false)
  isOnline             Boolean             @default(false)
  responseTime         String?

  // Relations
  doctorAvailabilities Availability[]       @relation("DoctorAvailability")
  doctorAppointments   Appointment[]        @relation("DoctorAppointments")
  patientAppointments  Appointment[]        @relation("PatientAppointments")
  transactions         CreditTransaction[]
  payouts              Payout[]
  emergencyCases       EmergencyCase[]      @relation("DoctorEmergencyCases")
  patientEmergencies   EmergencyCase[]      @relation("PatientEmergencyCases")
  emergencyCalls       EmergencyCall[]      @relation("DoctorEmergencyCalls")
  patientCalls         EmergencyCall[]      @relation("PatientEmergencyCalls")
  consultations        Consultation[]
  notifications        Notification[]
  kycVerifications     KycVerification[]
  healthMeasurements   HealthMeasurement[]  @relation("PatientHealthMeasurements")
  medicalDiagnoses     MedicalDiagnosis[]   @relation("PatientMedicalDiagnoses")
  emotionAnalyses      EmotionAnalysis[]    @relation("PatientEmotionAnalysis")
  emotionAlerts        EmotionAlert[]       @relation("PatientEmotionAlerts")
  medicalAIAlerts      MedicalAIAlert[]     @relation("PatientMedicalAIAlerts")
}

model Availability {
  id        String     @id @default(cuid())
  doctorId  String
  startTime DateTime
  endTime   DateTime
  status    SlotStatus @default(AVAILABLE)

  // Relations
  doctor      User         @relation("DoctorAvailability", fields: [doctorId], references: [id], onDelete: Cascade)
  appointment Appointment?

  @@index([doctorId, startTime])
}

model Appointment {
  id                   String            @id @default(cuid())
  patientId            String
  doctorId             String
  availabilityId       String?           @unique
  startTime            DateTime
  endTime              DateTime
  status               AppointmentStatus @default(SCHEDULED)
  notes                String?
  patientDescription   String?
  videoSessionId       String?
  videoSessionToken    String?
  createdAt            DateTime          @default(now())
  updatedAt            DateTime          @updatedAt

  // Relations
  patient      User          @relation("PatientAppointments", fields: [patientId], references: [id], onDelete: Restrict)
  doctor       User          @relation("DoctorAppointments", fields: [doctorId], references: [id], onDelete: Restrict)
  availability Availability? @relation(fields: [availabilityId], references: [id], onDelete: SetNull)

  @@index([status, createdAt])
  @@index([doctorId, startTime])
}

model EmergencyCase {
  id                  String             @id @default(cuid())
  userId              String?            // Can be null for anonymous emergencies
  symptoms            String             // JSON array of symptoms
  description         String
  patientInfo         String             // JSON object with patient details
  emergencyScore      Int                @default(0) // 0-10 severity score
  isEmergency         Boolean            @default(false)
  status              EmergencyStatus    @default(PENDING)
  assignedDoctorId    String?
  kycVerificationId   String?
  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt

  // Relations
  patient            User?              @relation("PatientEmergencyCases", fields: [userId], references: [id])
  assignedDoctor     User?              @relation("DoctorEmergencyCases", fields: [assignedDoctorId], references: [id])
  kycVerification    KycVerification?   @relation(fields: [kycVerificationId], references: [id])
  emergencyCalls     EmergencyCall[]
  consultations      Consultation[]

  @@index([status, isEmergency, createdAt])
}

model EmergencyCall {
  id              String          @id @default(cuid())
  emergencyId     String
  doctorId        String
  patientId       String?
  callType        CallType        @default(VIDEO)
  roomName        String
  status          CallStatus      @default(CONNECTING)
  startedAt       DateTime        @default(now())
  endedAt         DateTime?
  duration        Int?            // in seconds
  endReason       String?
  recordingUrl    String?

  // Relations
  emergency       EmergencyCase   @relation(fields: [emergencyId], references: [id])
  doctor          User            @relation("DoctorEmergencyCalls", fields: [doctorId], references: [id])
  patient         User?           @relation("PatientEmergencyCalls", fields: [patientId], references: [id])

  @@index([status, startedAt])
}

model KycVerification {
  id                    String               @id @default(cuid())
  userId                String?
  patientInfo           String               // JSON object
  aadharNumber          String
  panNumber             String
  insuranceNumber       String?
  verificationStatus    KycStatus            @default(PENDING)
  verificationFee       Float                @default(1.00)
  paymentIntentId       String?
  verificationDetails   String?              // JSON object with verification results
  verifiedAt            DateTime?
  createdAt             DateTime             @default(now())
  updatedAt             DateTime             @updatedAt

  // Relations
  user                  User?                @relation(fields: [userId], references: [id])
  emergencyCases        EmergencyCase[]

  @@unique([userId])
  @@index([verificationStatus, createdAt])
}

model Consultation {
  id              String           @id @default(cuid())
  emergencyId     String?
  doctorId        String
  patientId       String?
  type            ConsultationType @default(REGULAR)
  duration        Int?             // in seconds
  summary         String?          // JSON object
  diagnosis       String?
  prescription    String?          // JSON object
  followUpDate    DateTime?
  status          ConsultationStatus @default(SCHEDULED)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  // Relations
  emergency       EmergencyCase?   @relation(fields: [emergencyId], references: [id])
  doctor          User             @relation(fields: [doctorId], references: [id])

  @@index([status, type, createdAt])
}

model Notification {
  id          String              @id @default(cuid())
  doctorId    String?
  patientId   String?
  type        NotificationType
  title       String
  message     String
  data        String?             // JSON object
  isRead      Boolean             @default(false)
  createdAt   DateTime            @default(now())

  // Relations
  doctor      User?               @relation(fields: [doctorId], references: [id])

  @@index([isRead, createdAt])
}

model HealthMeasurement {
  id                   String    @id @default(cuid())
  sessionId            String
  patientId            String?
  appointmentId        String?
  heartRate            Int       @default(0)
  heartRateVariability Int       @default(0)
  respiratoryRate      Int       @default(0)
  stressLevel          Int       @default(0)
  systolicBP           Int       @default(0)
  diastolicBP          Int       @default(0)
  oxygenSaturation     Int       @default(0)
  timestamp            DateTime  @default(now())
  createdAt            DateTime  @default(now())

  // Relations
  patient              User?     @relation("PatientHealthMeasurements", fields: [patientId], references: [id])

  @@index([sessionId, timestamp])
  @@index([patientId, timestamp])
}

model HealthAlert {
  id               String    @id @default(cuid())
  sessionId        String
  patientId        String?
  appointmentId    String?
  alertType        String
  alertData        String    // JSON array of alerts
  severity         String    // 'low', 'medium', 'high', 'critical'
  vitalsSnapshot   String?   // JSON object of vitals at time of alert
  acknowledged     Boolean   @default(false)
  acknowledgedAt   DateTime?
  doctorResponse   String?
  timestamp        DateTime  @default(now())
  createdAt        DateTime  @default(now())

  @@index([sessionId, acknowledged])
  @@index([severity, acknowledged])
}

model MedicalDiagnosis {
  id                    String    @id @default(cuid())
  patientId             String
  sessionId             String
  appointmentId         String?
  rawAnalysis           String    // Full AI response text
  structuredDiagnosis   String    // JSON object with parsed diagnosis
  confidenceLevel       Int       @default(0)
  riskAssessment        String    // JSON object with risk data
  patientSymptoms       String?   // JSON array of symptoms
  patientVitals         String?   // JSON object of vitals
  timestamp             DateTime  @default(now())
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  // Relations
  patient               User      @relation("PatientMedicalDiagnoses", fields: [patientId], references: [id])

  @@index([patientId, timestamp])
  @@index([sessionId, timestamp])
}

model UrgentMedicalAlert {
  id               String    @id @default(cuid())
  patientId        String
  sessionId        String
  diagnosisId      String?
  alertType        String
  riskLevel        String    // 'medium', 'high', 'critical'
  alertMessage     String
  redFlags         String?   // JSON array of red flag symptoms
  acknowledged     Boolean   @default(false)
  acknowledgedAt   DateTime?
  acknowledgedBy   String?
  timestamp        DateTime  @default(now())
  createdAt        DateTime  @default(now())

  @@index([acknowledged, riskLevel])
  @@index([patientId, timestamp])
}

model TranslationSession {
  id                   String    @id @default(cuid())
  patientId            String?
  doctorId             String?
  sourceLanguage       String
  targetLanguage       String
  medicalContext       String?
  realTimeEnabled      Boolean   @default(true)
  status               String    @default("ACTIVE")
  totalTranslations    Int       @default(0)
  averageConfidence    Float     @default(0.0)
  medicalTermsTranslated Int     @default(0)
  createdAt            DateTime  @default(now())
  endedAt              DateTime?
  
  @@index([status, createdAt])
}

model MedicalTranslation {
  id                   String    @id @default(cuid())
  sessionId            String
  originalText         String
  translatedText       String
  sourceLanguage       String
  targetLanguage       String
  speaker              String
  isUrgent             Boolean   @default(false)
  confidence           Float     @default(0.0)
  medicalTermsDetected String?   // JSON array
  timestamp            DateTime  @default(now())
  createdAt            DateTime  @default(now())

  @@index([sessionId, timestamp])
}

model EmotionAnalysis {
  id                   String    @id @default(cuid())
  sessionId            String
  patientId            String?
  emotionData          String    // JSON object with emotion analysis
  stressLevel          Int       @default(0)
  anxietyLevel         Int       @default(0)
  painIndication       Int       @default(0)
  psychologicalDistress Int      @default(0)
  medicalIndicators    String?   // JSON array
  confidence           Float     @default(0.0)
  timestamp            DateTime  @default(now())
  createdAt            DateTime  @default(now())

  // Relations
  patient              User?     @relation("PatientEmotionAnalysis", fields: [patientId], references: [id])

  @@index([sessionId, timestamp])
  @@index([patientId, timestamp])
}

model EmotionAlert {
  id               String    @id @default(cuid())
  sessionId        String
  patientId        String?
  doctorId         String?
  alertType        String
  severity         String
  message          String
  emotionData      String?   // JSON object
  acknowledged     Boolean   @default(false)
  acknowledgedAt   DateTime?
  timestamp        DateTime  @default(now())
  createdAt        DateTime  @default(now())

  // Relations
  patient          User?     @relation("PatientEmotionAlerts", fields: [patientId], references: [id])

  @@index([sessionId, acknowledged])
  @@index([severity, acknowledged])
}

model DrugInteractionSession {
  id                        String    @id @default(cuid())
  patientId                 String
  doctorId                  String
  initialMedicationCount    Int       @default(0)
  finalMedicationCount      Int       @default(0)
  validatedMedicationCount  Int       @default(0)
  totalInteractionChecks    Int       @default(0)
  status                    String    @default("ACTIVE")
  createdAt                 DateTime  @default(now())
  endedAt                   DateTime?

  @@index([patientId, status])
}

model PatientMedication {
  id               String    @id @default(cuid())
  sessionId        String
  patientId        String
  medicationName   String
  rxcui            String?
  dosage           String?
  frequency        String?
  route            String    @default("oral")
  validated        Boolean   @default(false)
  status           String    @default("ACTIVE")
  addedAt          DateTime  @default(now())
  removedAt        DateTime?
  createdAt        DateTime  @default(now())

  @@index([sessionId, status])
  @@index([patientId, status])
}

model DrugInteractionCheck {
  id                   String    @id @default(cuid())
  sessionId            String
  patientId            String
  newMedicationName    String
  newMedicationRxcui   String?
  totalInteractions    Int       @default(0)
  riskLevel            String
  riskScore            Int       @default(0)
  requiresAction       Boolean   @default(false)
  recommendation       String?
  interactionData      String?   // JSON array
  riskAnalysis         String?   // JSON object
  timestamp            DateTime  @default(now())
  createdAt            DateTime  @default(now())

  @@index([sessionId, timestamp])
  @@index([riskLevel, requiresAction])
}

model DrugInteraction {
  id            String    @id @default(cuid())
  checkId       String
  sessionId     String
  drug1Name     String
  drug1Rxcui    String?
  drug2Name     String
  drug2Rxcui    String?
  description   String
  severity      String
  source        String    @default("RxNav")
  timestamp     DateTime  @default(now())
  createdAt     DateTime  @default(now())

  @@index([checkId])
  @@index([severity])
}

model DrugInteractionAlert {
  id                    String    @id @default(cuid())
  sessionId             String
  patientId             String
  checkId               String
  alertType             String
  severity              String
  message               String
  recommendation        String?
  interactionCount      Int       @default(0)
  criticalInteractions  Int       @default(0)
  majorInteractions     Int       @default(0)
  acknowledged          Boolean   @default(false)
  acknowledgedBy        String?
  acknowledgedAt        DateTime?
  timestamp             DateTime  @default(now())
  createdAt             DateTime  @default(now())

  @@index([sessionId, acknowledged])
  @@index([severity, acknowledged])
}

model MedicationChange {
  id              String    @id @default(cuid())
  sessionId       String
  patientId       String
  action          String    // 'add' or 'remove'
  medicationName  String
  medicationRxcui String?
  medicationData  String?   // JSON object
  interactionData String?   // JSON array
  riskData        String?   // JSON object
  timestamp       DateTime  @default(now())
  createdAt       DateTime  @default(now())

  @@index([sessionId, timestamp])
  @@index([patientId, action])
}

model MedicalAISession {
  id                        String    @id @default(cuid())
  patientId                 String
  doctorId                  String
  appointmentId             String?
  healthMonitoringEnabled   Boolean   @default(true)
  medicalDiagnosisEnabled   Boolean   @default(true)
  translationEnabled        Boolean   @default(true)
  emotionAnalysisEnabled    Boolean   @default(true)
  drugInteractionsEnabled   Boolean   @default(true)
  systemsInitialized        Int       @default(0)
  initializationData        String?   // JSON object
  endResults                String?   // JSON object
  status                    String    @default("ACTIVE")
  createdAt                 DateTime  @default(now())
  endedAt                   DateTime?

  @@index([patientId, status])
  @@index([doctorId, status])
}

model MedicalAIAlert {
  id                      String    @id @default(cuid())
  sessionId               String
  patientId               String
  doctorId                String
  alertType               String
  severity                String
  message                 String
  alertData               String?   // JSON object
  requiresImmediateAction Boolean   @default(false)
  acknowledged            Boolean   @default(false)
  acknowledgedBy          String?
  acknowledgedAt          DateTime?
  timestamp               DateTime  @default(now())
  createdAt               DateTime  @default(now())

  // Relations
  patient                 User      @relation("PatientMedicalAIAlerts", fields: [patientId], references: [id])

  @@index([sessionId, acknowledged])
  @@index([severity, acknowledged])
}

model CreditTransaction {
  id          String          @id @default(cuid())
  userId      String
  amount      Int
  type        TransactionType
  packageId   String?
  description String
  createdAt   DateTime        @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model CreditPackage {
  id          String  @id @default(cuid())
  name        String
  description String
  credits     Int
  price       Float
  active      Boolean @default(true)
}

model Payout {
  id          String      @id @default(cuid())
  doctorId    String
  amount      Float
  status      PayoutStatus @default(PENDING)
  stripePayoutId String?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  // Relations
  doctor User @relation(fields: [doctorId], references: [id], onDelete: Cascade)
}

// Enums
enum UserRole {
  UNASSIGNED
  PATIENT
  DOCTOR
  ADMIN
}

enum VerificationStatus {
  PENDING
  UNDER_REVIEW
  VERIFIED
  REJECTED
}

enum SlotStatus {
  AVAILABLE
  BOOKED
  BLOCKED
}

enum AppointmentStatus {
  SCHEDULED
  COMPLETED
  CANCELLED
}

enum TransactionType {
  CREDIT_PURCHASE
  APPOINTMENT_DEDUCTION
  ADMIN_ADJUSTMENT
}

enum PayoutStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum EmergencyStatus {
  PENDING
  URGENT
  IN_PROGRESS
  CONSULTATION
  CONSULTATION_COMPLETED
  RESOLVED
  CANCELLED
}

enum CallStatus {
  CONNECTING
  CONNECTED
  ON_HOLD
  COMPLETED
  FAILED
  CANCELLED
}

enum CallType {
  VIDEO
  AUDIO
  CHAT
}

enum KycStatus {
  PENDING
  IN_PROGRESS
  VERIFIED
  REJECTED
  EXPIRED
}

enum ConsultationType {
  REGULAR
  EMERGENCY
  FOLLOW_UP
  CONSULTATION
}

enum ConsultationStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  NO_SHOW
}

enum NotificationType {
  EMERGENCY_ALERT
  EMERGENCY_CALL
  APPOINTMENT_REMINDER
  CONSULTATION_REQUEST
  SYSTEM_NOTIFICATION
  PAYMENT_UPDATE
}